<?xml version="1.0" encoding="utf-8" ?>
<voicemail xmlns="http://www.innovaphone.com/xsd/voicemail6.xsd">

  <function define="Main">
    <assign out="$_pbxfwd" value="true" />
    <assign out="count" value="0" />
    <assign out="cpf" value="" />

    <!-- Following values are usually provided via query string in the VoiceMail Object URL-->
    <!-- <assign out="server" value="192.168.1.100:8080/routepoint/server/agent-logic.php" /> -->
    <!-- <assign out="fallback-e164" value="123" /> -->
    <!-- <assign out="fallback-name" value="wq" /> -->

    <!-- DTMF handling -->
    <event type="dtmf" block="false">

      <pbx-getdtmfdigit out-dtmf="$dtmf" />
      <dbg string="danio req: DTMF: " string2="$dtmf"/>
      <lib-strcat out-string="$cpf" string="$cpf" string2="$dtmf"/>
      <dbg string="danio req: CPF: " string2="$cpf"/>
      <!-- Verifique se 11 dÃ­gitos foram recebidos -->
      <lib-strlen string="$cpf" out="$lenght"/>
      <switch var="$lenght">
        <case equal="11">
          <!-- Tamanho atingido, verificar o cpf -->
          <dbg string="danilo req: DTMF: Tamanho atingido, verificar o CPF: " string2="$cpf"/>
          <call name="validadeCpf" />
        </case>
        <case not-equal="11">
          <assign out="wait" value="5"/>
          <if cond="$wait">
            <wait sec="$wait"/>
          </if>
        </case>
      </switch>
    </event>

    <call name="loop" />
    
  </function>

  <function define="loop">
    <assign out="$cpf" value="" />
    <dbg string="danilo req: Iniciando Loop do Menu CPF"/>
    <while notcond="$stop">
      <!-- worker loop: do stuff -->
      <dbg string="danilo req: worker loop"/>

      <!-- Play Prompt and Wait -->
      <store-get root="" name="prompts/menu-cpf.$coder" out-url="$ctrl" />
      <pbx-prompt url="$ctrl" sec="35" repeat="false"/>
      
      <assign out="wait" value="5"/>
      <if cond="$wait">
        <wait sec="$wait"/>
      </if>
      <lib-strcat out-string="$count" string="$count" string2="1"/>
      <dbg string="worker loop: count " string2="$count"/>
      <switch var="$count">
        <case equal="011">
          <!-- End Loop -->
          <assign out="$stop" value="true"/>
        </case>
        <case not-equal="011">
          <!-- Play Prompt and Repeat -->
          <store-get root="" name="prompts/opcao_invalida.$coder" out-url="$ctrl" />
          <pbx-prompt url="$ctrl" sec="10" repeat="false"/>
        </case>
      </switch>
    </while>
    <pbx-disc/>
  
  </function>

  <!-- do GET validadeCpf request -->
  <function define="validadeCpf">
    <dbg string="danilo req: Iniciando validadeCpf"/>
    <assign out="query-string" value="" />

    <lib-enc string="$cpf" out-string="$cpf" type="url"/>
    <lib-strcat string="$query-string" string2="?cpf=" out-string="$query-string"/>
    <lib-strcat string="$query-string" string2="$cpf" out-string="$query-string"/>
    <dbg string="danilo req: validadeCpf: " string2="$query-string"/>
    <!-- <assign out="ok" value="0"/> -->
    
    <pbx-getcallinfo out-cgpn="$cgpn" out-cdpn="$cdpn" out-leg2="$leg2" out-leg2-reason="$leg2-reason" out-leg2-count="$leg2-count" out-ctl-call="$ctl-call" out-h323="$h323" out-confid="$confid" out-calling-name="$calling-name"/>

    <lib-enc string="$cgpn" out-string="$cgpn" type="url"/>
    <lib-strcat string="$query-string" string2="&amp;cgpn=" out-string="$query-string"/>
    <lib-strcat string="$query-string" string2="$cgpn" out-string="$query-string"/>

    <if cond="$server">
      <lib-dec string="$server" out-string="$server" type="url"/>
      <lib-strcat string="$server" string2="validateCpf" out-string="$serverUri"/>
      <lib-strcat string="$serverUri" string2="$query-string" out-string="$exec-url"/>
    </if>
    <else>
      <store-get root="" name="validateCpf" out-url="$exec-url"/>
    </else>
    <dbg string="danilo req: validadeCpf exec-url " string2="$exec-url"/>
    <exec url="$exec-url"/>
    <dbg string="danilo req: validadeCpf result " string2="$ok"/>

    <if notcond="$ok">
      <store-get root="" name="prompts/naolocalizado.$coder" out-url="$ctrl" />
      <pbx-prompt url="$ctrl" sec="35" repeat="false"/>
      <call name="loop" />
    </if>
    <else>
      <!-- Tratar aqui a resposta -->
      <dbg string="danilo req: validadeCpf result " string2="$amount"/>

      <store-get root="" name="prompts/sucesso.$coder" out-url="$ctrl" />
      <pbx-prompt url="$ctrl" sec="35" repeat="false"/>
      <pbx-xfer e164="$2000"/>
      <pbx-disc/>


    </else>

  </function>

</voicemail>

 